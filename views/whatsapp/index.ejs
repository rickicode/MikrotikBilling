<%- include('../partials/header', { title: 'WhatsApp Management', currentUrl: '/whatsapp/management' }) %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">WhatsApp Management</h1>
                <p class="text-slate-400">Kelola koneksi, kirim pesan, dan monitor aktivitas WhatsApp</p>
            </div>
            <div class="mt-4 sm:mt-0 flex space-x-3">
                <button onclick="refreshStatus()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 font-medium">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh Status
                </button>
                <button onclick="exportWhatsAppData()" class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors duration-200 font-medium">
                    <i class="fas fa-download mr-2"></i>
                    Export Data
                </button>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="mb-8">
        <nav class="flex space-x-1 bg-slate-800 p-1 rounded-xl" aria-label="WhatsApp Management Tabs">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-button active flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-home mr-2"></i>
                Dashboard
            </button>
            <button onclick="switchTab('messages')" id="tab-messages" class="tab-button flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-comments mr-2"></i>
                Messages
            </button>
            <button onclick="switchTab('templates')" id="tab-templates" class="tab-button flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-file-alt mr-2"></i>
                Templates
            </button>
            <button onclick="switchTab('bulk')" id="tab-bulk" class="tab-button flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-users mr-2"></i>
                Bulk Send
            </button>
            <button onclick="switchTab('bot')" id="tab-bot" class="tab-button flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-robot mr-2"></i>
                Bot
            </button>
            <button onclick="switchTab('settings')" id="tab-settings" class="tab-button flex-1 flex items-center justify-center px-4 py-3 text-sm font-medium rounded-lg transition-all duration-200">
                <i class="fas fa-cog mr-2"></i>
                Settings
            </button>
        </nav>
    </div>

  <!-- Tab Content Container -->
    <div class="space-y-6">

        <!-- Dashboard Tab -->
        <div id="tab-content-dashboard" class="tab-content active">
            <!-- Connection Status Card -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-white flex items-center">
                        <i class="fab fa-whatsapp text-green-500 mr-3 text-xl"></i>
                        Connection Status
                    </h2>
                    <div class="flex items-center gap-2">
                        <span id="whatsappConnectionStatus" class="px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-sm font-medium">
                            <i class="fas fa-circle text-slate-500 mr-2 text-xs"></i>
                            Checking...
                        </span>
                        <span id="sessionHealthIndicator" class="hidden px-2 py-1 bg-green-600/20 text-green-400 rounded-full text-xs font-medium">
                            <i class="fas fa-shield-alt mr-1"></i>Session Sehat
                        </span>
                        <span id="permanentSessionBadge" class="hidden px-2 py-1 bg-blue-600/20 text-blue-400 rounded-full text-xs font-medium">
                            <i class="fas fa-lock mr-1"></i>Permanen
                        </span>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column - QR Code and Info -->
                        <div class="space-y-4">
                            <div id="whatsappQrCodeContainer" class="hidden">
                                <div class="bg-slate-900 rounded-lg p-4 text-center">
                                    <h3 class="text-sm font-medium text-slate-300 mb-3">Scan QR Code with WhatsApp</h3>
                                    <div class="inline-block p-2 bg-white rounded-lg">
                                        <div id="whatsappQrCodeImage" class="w-48 h-48 flex items-center justify-center">
                                            <!-- QR Code or success icon will be displayed here -->
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-center gap-3 mt-3">
                                        <p id="qrExpiryTime" class="text-xs text-slate-400">QR Code expires in 2:00</p>
                                        <button id="refreshQRBtn" onclick="refreshQRCode()" class="hidden inline-flex items-center px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg transition-colors duration-200" title="Refresh QR Code">
                                            <i class="fas fa-sync-alt mr-1"></i>
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column - Status Information and Instructions -->
                        <div class="space-y-4">
                            <div id="connectionInfo" class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400">Status:</span>
                                    <span id="whatsappStatusText" class="text-white font-medium">Checking connection...</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400">Phone:</span>
                                    <span id="whatsappPhoneNumber" class="text-white font-medium">Not connected</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400">Last Activity:</span>
                                    <span id="whatsappLastActivity" class="text-white font-medium">Never</span>
                                </div>
                                <div id="permanentSessionIndicator" class="hidden flex items-center justify-between">
                                    <span class="text-slate-400">Session Type:</span>
                                    <span class="text-green-400 font-medium">
                                        <i class="fas fa-lock mr-1"></i>Permanent Session
                                    </span>
                                </div>
                            </div>

                            <div id="connectionActions" class="flex flex-wrap gap-3">
                                <button id="whatsappDisconnectBtn" onclick="disconnectWhatsApp()" class="hidden px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors font-medium">
                                    <i class="fas fa-unlink mr-2"></i> Disconnect
                                </button>
                                <button id="whatsappReconnectBtn" onclick="reconnectWhatsApp()" class="hidden px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors font-medium">
                                    <i class="fas fa-sync-alt mr-2"></i> Reconnect
                                </button>
                            </div>

                            <div id="whatsappInstructions" class="hidden bg-blue-900/30 border border-blue-700/50 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-400 mb-2">
                                    <i class="fas fa-info-circle mr-2"></i>How to connect WhatsApp:
                                </h4>
                                <ol class="text-xs text-slate-300 space-y-1">
                                    <li>1. Open WhatsApp on your smartphone</li>
                                    <li>2. Go to Menu > Linked Devices</li>
                                    <li>3. Tap "Link a device"</li>
                                    <li>4. Scan the QR code above with your phone</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Messages Today -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6 hover:border-slate-600 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm font-medium">Messages Today</p>
                            <p id="messagesToday" class="text-3xl font-bold text-white mt-2">0</p>
                        </div>
                        <div class="p-3 bg-blue-600/20 rounded-lg">
                            <i class="fas fa-calendar-day text-blue-500 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Sent Messages -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6 hover:border-slate-600 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm font-medium">Sent Messages</p>
                            <p id="messagesSent" class="text-3xl font-bold text-white mt-2">0</p>
                        </div>
                        <div class="p-3 bg-green-600/20 rounded-lg">
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Delivered Messages -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6 hover:border-slate-600 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm font-medium">Delivered Messages</p>
                            <p id="messagesDelivered" class="text-3xl font-bold text-white mt-2">0</p>
                        </div>
                        <div class="p-3 bg-purple-600/20 rounded-lg">
                            <i class="fas fa-envelope-check text-purple-500 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Failed Messages -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6 hover:border-slate-600 transition-colors">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-slate-400 text-sm font-medium">Failed Messages</p>
                            <p id="messagesFailed" class="text-3xl font-bold text-white mt-2">0</p>
                        </div>
                        <div class="p-3 bg-red-600/20 rounded-lg">
                            <i class="fas fa-times-circle text-red-500 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
                <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button onclick="showSendMessageModal()" class="flex flex-col items-center justify-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors group">
                        <i class="fas fa-paper-plane text-blue-500 text-xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-white text-sm font-medium">Send Message</span>
                    </button>
                    <button onclick="switchTab('messages')" class="flex flex-col items-center justify-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors group">
                        <i class="fas fa-history text-purple-500 text-xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-white text-sm font-medium">View History</span>
                    </button>
                    <button onclick="switchTab('templates')" class="flex flex-col items-center justify-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors group">
                        <i class="fas fa-file-alt text-green-500 text-xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-white text-sm font-medium">Manage Templates</span>
                    </button>
                    <button onclick="testWhatsApp()" class="flex flex-col items-center justify-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors group">
                        <i class="fas fa-stethoscope text-yellow-500 text-xl mb-2 group-hover:scale-110 transition-transform"></i>
                        <span class="text-white text-sm font-medium">Test Connection</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Tab -->
        <div id="tab-content-messages" class="tab-content hidden">
            <div class="bg-slate-800 rounded-xl border border-slate-700">
                <!-- Messages Header -->
                <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-white">Message History</h3>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="messageSearch" placeholder="Search messages..."
                                   class="pl-10 pr-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                        </div>
                        <select id="messageFilter" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Messages</option>
                            <option value="sent">Sent</option>
                            <option value="delivered">Delivered</option>
                            <option value="failed">Failed</option>
                            <option value="pending">Pending</option>
                        </select>
                        <button onclick="loadRecentMessages()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Messages Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-slate-900">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">From/To</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Message</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="messagesTableBody" class="divide-y divide-slate-700">
                            <tr>
                                <td colspan="6" class="px-6 py-12 text-center text-slate-400">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading messages...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="px-6 py-4 border-t border-slate-700 flex items-center justify-between">
                    <div class="text-sm text-slate-400">
                        Showing <span id="messageCount">0</span> messages
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="previousPage()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded transition-colors">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="nextPage()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded transition-colors">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Tab -->
        <div id="tab-content-templates" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Templates Header -->
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-white">Message Templates</h3>
                    <button onclick="showCreateTemplateModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i> Create Template
                    </button>
                </div>

                <!-- Templates Grid -->
                <div id="templatesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="col-span-full text-center text-slate-400 py-12">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading templates...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Send Tab -->
        <div id="tab-content-bulk" class="tab-content hidden">
            <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
                <h3 class="text-lg font-semibold text-white mb-6">Bulk Message Sender</h3>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Recipients -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Recipients</label>
                        <div class="space-y-3">
                            <div class="flex space-x-2">
                                <button onclick="setRecipientMode('manual')" id="manualModeBtn" class="flex-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors text-sm">
                                    Manual Entry
                                </button>
                                <button onclick="setRecipientMode('file')" id="fileModeBtn" class="flex-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors text-sm">
                                    File Upload
                                </button>
                                <button onclick="setRecipientMode('customers')" id="customersModeBtn" class="flex-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors text-sm">
                                    Customers
                                </button>
                            </div>

                            <!-- Manual Entry -->
                            <div id="manualEntry" class="space-y-3">
                                <textarea id="recipientsList" placeholder="Enter phone numbers (one per line)&#10;Example:&#10;628123456789&#10;628987654321"
                                          class="w-full h-32 px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                <p class="text-xs text-slate-400">Include country code (62 for Indonesia)</p>
                            </div>

                            <!-- File Upload -->
                            <div id="fileUpload" class="hidden">
                                <div class="border-2 border-dashed border-slate-600 rounded-lg p-8 text-center">
                                    <i class="fas fa-file-upload text-3xl text-slate-400 mb-2"></i>
                                    <p class="text-slate-300 mb-2">Drop your CSV/Excel file here or click to browse</p>
                                    <input type="file" id="bulkFileInput" accept=".csv,.xlsx,.xls" class="hidden">
                                    <button onclick="document.getElementById('bulkFileInput').click()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                        Choose File
                                    </button>
                                </div>
                            </div>

                            <!-- Customer Selection -->
                            <div id="customerSelection" class="hidden">
                                <select id="customerFilter" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="all">All Customers</option>
                                    <option value="active">Active Customers</option>
                                    <option value="expired">Expired Customers</option>
                                    <option value="balance">Customers with Balance</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Message Composition -->
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Message</label>
                        <div class="space-y-3">
                            <select id="bulkTemplateSelect" onchange="fillBulkTemplate()" class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Choose template (optional)</option>
                            </select>
                            <textarea id="bulkMessage" placeholder="Type your message here..."
                                      class="w-full h-32 px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="flex justify-between items-center">
                                <span id="charCount" class="text-xs text-slate-400">0 / 1600 characters</span>
                                <button onclick="insertVariable()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded transition-colors text-sm">
                                    <i class="fas fa-code mr-1"></i> Insert Variable
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Send Options -->
                <div class="mt-6 pt-6 border-t border-slate-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="scheduleSend" class="mr-2">
                                <span class="text-slate-300">Schedule for later</span>
                            </label>
                            <input type="datetime-local" id="scheduleTime" class="hidden px-3 py-1 bg-slate-700 border border-slate-600 rounded text-white text-sm">
                            <select id="prioritySelect" class="px-3 py-1 bg-slate-700 border border-slate-600 rounded text-white text-sm">
                                <option value="normal">Normal Priority</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="recipientCount" class="text-sm text-slate-400">0 recipients</span>
                            <button onclick="previewBulkSend()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                <i class="fas fa-eye mr-2"></i> Preview
                            </button>
                            <button onclick="sendBulkMessages()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium">
                                <i class="fas fa-paper-plane mr-2"></i> Send Messages
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot Tab -->
        <div id="tab-content-bot" class="tab-content hidden">
            <!-- Bot Status Card -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-white flex items-center">
                        <i class="fas fa-robot text-blue-500 mr-3 text-xl"></i>
                        Bot Management
                    </h2>
                    <span id="botStatus" class="px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-sm font-medium">
                        <i class="fas fa-circle text-slate-500 mr-2 text-xs"></i>
                        Checking...
                    </span>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Bot Info -->
                        <div class="space-y-4">
                            <div class="bg-slate-900 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-slate-300 mb-3">Bot Configuration</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-400">Status:</span>
                                        <span id="botStatusText" class="text-white font-medium">Checking...</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-400">Command:</span>
                                        <span id="botCommandText" class="text-white font-medium">/info</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-slate-400">Last Updated:</span>
                                        <span id="botLastUpdated" class="text-white font-medium">Never</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bot Actions -->
                        <div class="space-y-4">
                            <div class="bg-slate-900 rounded-lg p-4">
                                <h3 class="text-sm font-medium text-slate-300 mb-3">Bot Actions</h3>
                                <div class="space-y-3">
                                    <button id="toggleBotBtn" onclick="toggleBot()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors font-medium">
                                        <i class="fas fa-power-off mr-2"></i>
                                        <span id="toggleBotText">Enable Bot</span>
                                    </button>
                                    <button onclick="showUpdateCommandModal()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors font-medium">
                                        <i class="fas fa-edit mr-2"></i>
                                        Update Command
                                    </button>
                                    <button onclick="showTestBotModal()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors font-medium">
                                        <i class="fas fa-flask mr-2"></i>
                                        Test Bot
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot Instructions -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-slate-700">
                    <h3 class="text-lg font-semibold text-white flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                        Bot Instructions
                    </h3>
                </div>
                <div class="p-6">
                    <div class="bg-slate-900 rounded-lg p-6">
                        <h4 class="text-md font-semibold text-slate-200 mb-4">How to Use the WhatsApp Bot</h4>
                        <div class="space-y-4 text-sm text-slate-300">
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">1</span>
                                <div>
                                    <p class="font-medium">Customer sends message to WhatsApp</p>
                                    <p class="text-slate-400 mt-1">Customer can send any of these commands: <code class="bg-slate-800 px-2 py-1 rounded text-xs">/info</code>, <code class="bg-slate-800 px-2 py-1 rounded text-xs">info</code>, <code class="bg-slate-800 px-2 py-1 rounded text-xs">cek info</code></p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">2</span>
                                <div>
                                    <p class="font-medium">Bot recognizes customer phone number</p>
                                    <p class="text-slate-400 mt-1">System automatically matches the WhatsApp number with customer database</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">3</span>
                                <div>
                                    <p class="font-medium">Bot sends customer information</p>
                                    <p class="text-slate-400 mt-1">Includes name, active services (PPPoE/Hotspot), real-time connection status, and expiry information</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sample Response -->
            <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-700">
                    <h3 class="text-lg font-semibold text-white flex items-center">
                        <i class="fas fa-comment-dots text-green-500 mr-3"></i>
                        Sample Bot Response
                    </h3>
                </div>
                <div class="p-6">
                    <div class="bg-slate-900 rounded-lg p-6 font-mono text-sm">
                        <div class="text-green-400 mb-2">ü§ñ BOT INFO PELANGGAN</div>
                        <div class="text-slate-300 mb-4">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
                        <div class="text-slate-300 space-y-2">
                            <div>üë§ <span class="text-blue-400">Data Pelanggan</span></div>
                            <div>üìõ Nama: Ahmad Rizki</div>
                            <div>üì± Telepon: 08123456789</div>
                            <div class="mt-3">üìä <span class="text-blue-400">Status Layanan Aktif</span></div>
                            <div>‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>
                            <div>üìã <span class="text-yellow-400">Layanan 1: PPPoE</span></div>
                            <div>üë§ Username: ahmad_rizki</div>
                            <div>üîë Password: aHm@d123</div>
                            <div>üì¶ Paket: 10Mbps Premium</div>
                            <div>üí∞ Harga: Rp 150,000</div>
                            <div>üîå Status: üü¢ Terhubung</div>
                            <div>‚è±Ô∏è Uptime: 2 hari 5 jam</div>
                            <div>üìÖ Expired: 25 Desember 2024, 23:59 (5 hari lagi)</div>
                        </div>
                        <div class="text-slate-400 mt-4 text-xs">*Real-time status from Mikrotik*</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-content-settings" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Connection Settings -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Connection Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Auto Reconnect</label>
                            <label class="flex items-center">
                                <input type="checkbox" id="autoReconnect" class="mr-2">
                                <span class="text-slate-400">Automatically reconnect on disconnection</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">QR Code Refresh Interval</label>
                            <select id="qrRefreshInterval" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="120">2 minutes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Session Timeout</label>
                            <select id="sessionTimeout" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                <option value="3600">1 hour</option>
                                <option value="7200">2 hours</option>
                                <option value="14400">4 hours</option>
                                <option value="28800">8 hours</option>
                                <option value="86400">24 hours</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Message Settings -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Message Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Rate Limit (messages/second)</label>
                            <input type="number" id="rateLimit" value="1" min="1" max="10" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Retry Attempts</label>
                            <input type="number" id="retryAttempts" value="3" min="0" max="10" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Message Retention</label>
                            <select id="messageRetention" class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white">
                                <option value="7">7 days</option>
                                <option value="30">30 days</option>
                                <option value="90">90 days</option>
                                <option value="365">1 year</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Notifications</h3>
                    <div class="space-y-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyConnection" class="mr-2">
                            <span class="text-slate-400">Connection status changes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyMessageStatus" class="mr-2">
                            <span class="text-slate-400">Message delivery updates</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyErrors" class="mr-2">
                            <span class="text-slate-400">Error notifications</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyQueue" class="mr-2">
                            <span class="text-slate-400">Queue status updates</span>
                        </label>
                    </div>
                </div>

                <!-- Maintenance -->
                <div class="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h3 class="text-lg font-semibold text-white mb-4">Maintenance</h3>
                    <div class="space-y-4">
                        <button onclick="clearMessageHistory()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-trash mr-2"></i> Clear Message History
                        </button>
                        <button onclick="resetWhatsAppSession()" class="w-full px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i> Reset WhatsApp Session
                        </button>
                        <button onclick="exportWhatsAppSettings()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-download mr-2"></i> Export Settings
                        </button>
                        <button onclick="importWhatsAppSettings()" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-upload mr-2"></i> Import Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Send Message Modal -->
    <div id="sendMessageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Send Message</h3>
                <button onclick="closeSendMessageModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="sendMessageForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Recipient Number</label>
                    <input type="tel" id="recipientNumber" placeholder="628123456789" required
                           class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-slate-400 mt-1">Include country code (62 for Indonesia)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Message</label>
                    <textarea id="messageContent" rows="4" placeholder="Enter your message..." required
                              class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Template</label>
                    <select id="templateSelect" onchange="fillTemplate()"
                            class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select template...</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeSendMessageModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="sendMessage()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i> Send
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Template Modal -->
    <div id="createTemplateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-slate-800 rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Create Message Template</h3>
                <button onclick="closeCreateTemplateModal()" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="createTemplateForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Template Name</label>
                        <input type="text" id="templateName" required
                               class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">Category</label>
                        <select id="templateCategory" required
                                class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="general">General</option>
                            <option value="notification">Notification</option>
                            <option value="marketing">Marketing</option>
                            <option value="support">Support</option>
                            <option value="billing">Billing</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Message Content</label>
                    <textarea id="templateContent" rows="6" placeholder="Enter template content..." required
                              class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <p class="text-xs text-slate-400 mt-1">Use variables like {customer_name}, {voucher_code}, etc.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1">Available Variables</label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" onclick="insertVariableAtCursor('{customer_name}')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs">
                            {customer_name}
                        </button>
                        <button type="button" onclick="insertVariableAtCursor('{voucher_code}')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs">
                            {voucher_code}
                        </button>
                        <button type="button" onclick="insertVariableAtCursor('{package_name}')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs">
                            {package_name}
                        </button>
                        <button type="button" onclick="insertVariableAtCursor('{expiry_date}')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs">
                            {expiry_date}
                        </button>
                        <button type="button" onclick="insertVariableAtCursor('{balance}')" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded text-xs">
                            {balance}
                        </button>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeCreateTemplateModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="testTemplate()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-stethoscope mr-2"></i> Test
                    </button>
                    <button type="button" onclick="saveTemplate()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i> Save Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Bot Command Modal -->
<div id="updateCommandModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-edit text-purple-500 mr-3"></i>
                Update Bot Command
            </h3>
            <button onclick="closeUpdateCommandModal()" class="text-slate-400 hover:text-white transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="updateCommandForm" onsubmit="updateBotCommand(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Bot Command</label>
                    <input type="text" id="newBotCommand" required placeholder="Enter new bot command (e.g., /info, /status)"
                           class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <p class="text-xs text-slate-400 mt-1">Commands like: /info, /status, /cek, cek info, status</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeUpdateCommandModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-save mr-2"></i> Update Command
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test Bot Modal -->
<div id="testBotModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-xl w-full max-w-md mx-4">
        <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white flex items-center">
                <i class="fas fa-flask text-green-500 mr-3"></i>
                Test WhatsApp Bot
            </h3>
            <button onclick="closeTestBotModal()" class="text-slate-400 hover:text-white transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6">
            <form id="testBotForm" onsubmit="testBotFunction(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Phone Number</label>
                    <input type="text" id="testPhoneNumber" required placeholder="08123456789"
                           class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <p class="text-xs text-slate-400 mt-1">Format: 08123456789 or +628123456789</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-300 mb-2">Test Message</label>
                    <textarea id="testMessage" required placeholder="Enter test message" rows="3"
                              class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeTestBotModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i> Send Test
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<%- include('../partials/footer', { scripts: ['/public/js/whatsapp.js'] }) %>

<script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize WhatsApp management
        initializeWhatsAppManagement();

        // Set active tab
        switchTab('dashboard');

        // Load initial data
        refreshStatus();
        loadRecentMessages();
        loadTemplates();
        loadTemplatesToSelects();

        // Auto-refresh intervals
        setInterval(refreshStatus, 30000);
        setInterval(loadRecentMessages, 60000);
    });
</script>