<%- include('../partials/header', { title: 'Dashboard', currentUrl: '/' }) %>

<!-- Main Content -->
<main id="main-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Dashboard</h1>
                <p class="text-slate-400">Ringkasan sistem dan monitoring real-time</p>
            </div>
            <div class="mt-4 sm:mt-0 flex gap-3">
                <button class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors duration-200 border border-slate-600" id="refreshDashboardBtn">
                    <i class="bi bi-arrow-clockwise mr-2"></i>
                    Refresh
                </button>
                <button class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-medium rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg" id="showQuickActionsBtn">
                    <i class="bi bi-lightning mr-2"></i>
                    Quick Actions
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Pelanggan -->
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 hover:shadow-lg hover:shadow-blue-500/10 transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-slate-400 text-sm font-medium mb-1">Total Pelanggan</p>
                    <p class="text-3xl font-bold text-white" id="totalCustomers">
                        <div class="w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    </p>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-14 h-14 bg-blue-500/10 rounded-xl flex items-center justify-center border border-blue-500/20">
                        <i class="bi bi-people text-blue-400 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-green-400 flex items-center font-medium">
                    <i class="bi bi-arrow-up mr-1"></i>
                    <span id="customersGrowth">+12%</span>
                </span>
                <span class="text-slate-500 ml-2">dari bulan lalu</span>
            </div>
        </div>

        <!-- Pelanggan Aktif -->
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 hover:shadow-lg hover:shadow-green-500/10 transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-slate-400 text-sm font-medium mb-1">Pelanggan Aktif</p>
                    <p class="text-3xl font-bold text-white" id="activeCustomers">
                        <div class="w-6 h-6 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></div>
                    </p>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-14 h-14 bg-green-500/10 rounded-xl flex items-center justify-center border border-green-500/20">
                        <i class="bi bi-person-check text-green-400 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-green-400 flex items-center font-medium">
                    <i class="bi bi-arrow-up mr-1"></i>
                    <span id="activeGrowth">+8%</span>
                </span>
                <span class="text-slate-500 ml-2">dari bulan lalu</span>
            </div>
        </div>

        <!-- Voucher Tersedia -->
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 hover:shadow-lg hover:shadow-yellow-500/10 transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-slate-400 text-sm font-medium mb-1">Voucher Tersedia</p>
                    <p class="text-3xl font-bold text-white" id="availableVouchers">
                        <div class="w-6 h-6 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
                    </p>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-14 h-14 bg-yellow-500/10 rounded-xl flex items-center justify-center border border-yellow-500/20">
                        <i class="bi bi-ticket-perforated text-yellow-400 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-blue-400 flex items-center font-medium">
                    <i class="bi bi-info-circle mr-1"></i>
                    <span id="voucherPercentage">65%</span>
                </span>
                <span class="text-slate-500 ml-2">tersedia</span>
            </div>
        </div>

        <!-- Revenue Bulan Ini -->
        <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 hover:shadow-lg hover:shadow-purple-500/10 transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-slate-400 text-sm font-medium mb-1">Revenue Bulan Ini</p>
                    <p class="text-3xl font-bold text-white" id="monthlyRevenue">
                        <div class="w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                    </p>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-14 h-14 bg-purple-500/10 rounded-xl flex items-center justify-center border border-purple-500/20">
                        <i class="bi bi-cash-stack text-purple-400 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-green-400 flex items-center font-medium">
                    <i class="bi bi-arrow-up mr-1"></i>
                    <span id="revenueGrowth">+23%</span>
                </span>
                <span class="text-slate-500 ml-2">dari bulan lalu</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions Panel (Hidden by default) -->
    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6 mb-8 hidden" id="quickActionsPanel">
        <h6 class="text-blue-400 font-medium mb-4 flex items-center">
            <i class="bi bi-lightning-fill mr-2"></i>
            Quick Actions
        </h6>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <a href="/vouchers/create" class="flex flex-col items-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors duration-200 text-center group">
                <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center mb-3 group-hover:bg-blue-500/30 transition-colors">
                    <i class="bi bi-plus-circle text-blue-400 text-xl"></i>
                </div>
                <span class="text-slate-300 font-medium">Generate Voucher</span>
                <span class="text-slate-500 text-sm">Buat voucher baru</span>
            </a>
            <a href="/customers/create" class="flex flex-col items-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors duration-200 text-center group">
                <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center mb-3 group-hover:bg-green-500/30 transition-colors">
                    <i class="bi bi-person-plus text-green-400 text-xl"></i>
                </div>
                <span class="text-slate-300 font-medium">Tambah Pelanggan</span>
                <span class="text-slate-500 text-sm">Registrasi baru</span>
            </a>
            <a href="/pppoe/create" class="flex flex-col items-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors duration-200 text-center group">
                <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center mb-3 group-hover:bg-purple-500/30 transition-colors">
                    <i class="bi bi-network-wired text-purple-400 text-xl"></i>
                </div>
                <span class="text-slate-300 font-medium">Create PPPoE</span>
                <span class="text-slate-500 text-sm">User PPPoE baru</span>
            </a>
            <a href="/payments" class="flex flex-col items-center p-4 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors duration-200 text-center group">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-xl flex items-center justify-center mb-3 group-hover:bg-yellow-500/30 transition-colors">
                    <i class="bi bi-credit-card text-yellow-400 text-xl"></i>
                </div>
                <span class="text-slate-300 font-medium">Payment</span>
                <span class="text-slate-500 text-sm">Kelola pembayaran</span>
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Recent Activity -->
        <div class="lg:col-span-2">
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                    <h6 class="text-white font-medium mb-0 flex items-center">
                        <i class="bi bi-activity mr-2"></i>
                        Aktivitas Terkini
                    </h6>
                </div>
                <div class="p-6">
                    <div id="recentActivity" class="space-y-4">
                        <div class="text-center text-slate-400 py-8">
                            <i class="bi bi-clock-history text-4xl mb-3"></i>
                            <p>Memuat aktivitas terkini...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="lg:col-span-1">
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden mb-8">
                <div class="bg-gradient-to-r from-green-600 to-green-700 px-6 py-4">
                    <h6 class="text-white font-medium mb-0 flex items-center">
                        <i class="bi bi-cpu mr-2"></i>
                        Status Sistem
                    </h6>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <!-- Mikrotik Connection -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="bi bi-router text-green-400 mr-2"></i>
                                <span class="text-slate-300">Mikrotik</span>
                            </div>
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-medium" id="mikrotikStatus">
                                Connected
                            </span>
                        </div>

                        <!-- Database Status -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="bi bi-database text-green-400 mr-2"></i>
                                <span class="text-slate-300">Database</span>
                            </div>
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-medium">
                                Healthy
                            </span>
                        </div>

                        <!-- WhatsApp Status -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="bi bi-whatsapp text-green-400 mr-2"></i>
                                <span class="text-slate-300">WhatsApp</span>
                            </div>
                            <span class="px-2 py-1 bg-green-500/20 text-green-400 rounded-full text-xs font-medium" id="whatsappStatus">
                                Connected
                            </span>
                        </div>

                        <!-- Scheduler Status -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="bi bi-clock text-blue-400 mr-2"></i>
                                <span class="text-slate-300">Scheduler</span>
                            </div>
                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full text-xs font-medium">
                                Running
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Users Summary -->
            <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4">
                    <h6 class="text-white font-medium mb-0 flex items-center">
                        <i class="bi bi-people-fill mr-2"></i>
                        User Aktif
                    </h6>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <!-- Hotspot Users -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-300">Hotspot Users</span>
                                <span class="text-white font-medium" id="hotspotActiveUsers">0</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-yellow-500 h-2 rounded-full transition-all duration-500" id="hotspotProgress" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- PPPoE Users -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-slate-300">PPPoE Users</span>
                                <span class="text-white font-medium" id="pppoeActiveUsers">0</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full transition-all duration-500" id="pppoeProgress" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Total Bandwidth -->
                        <div class="pt-4 border-t border-slate-700">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-400 text-sm">Total Bandwidth</span>
                                <span class="text-blue-400 font-medium" id="totalBandwidth">0 Mbps</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    setupEventListeners();

    // Auto-refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
});

function setupEventListeners() {
    // Refresh button
    document.getElementById('refreshDashboardBtn').addEventListener('click', function() {
        this.querySelector('i').classList.add('fa-spin');
        loadDashboardData().finally(() => {
            this.querySelector('i').classList.remove('fa-spin');
        });
    });

    // Quick Actions toggle
    document.getElementById('showQuickActionsBtn').addEventListener('click', function() {
        const panel = document.getElementById('quickActionsPanel');
        panel.classList.toggle('hidden');
    });
}

async function loadDashboardData() {
    try {
        // Load dashboard statistics
        const response = await fetch('/api/dashboard/stats');
        const stats = await response.json();

        if (stats.success) {
            updateStatistics(stats.data);
            updateRecentActivity(stats.data.recentActivity || []);
            updateActiveUsers(stats.data.activeUsers || {});
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Set default values on error
        setDefaultValues();
    }
}

function updateStatistics(data) {
    // Update customers statistics
    updateStatCard('totalCustomers', data.totalCustomers || 0);
    updateStatCard('activeCustomers', data.activeCustomers || 0);

    // Update vouchers
    updateStatCard('availableVouchers', data.availableVouchers || 0);

    // Update revenue
    const revenueElement = document.getElementById('monthlyRevenue');
    if (revenueElement) {
        revenueElement.textContent = formatCurrency(data.monthlyRevenue || 0);
    }

    // Update growth indicators
    updateGrowthIndicator('customersGrowth', data.customersGrowth);
    updateGrowthIndicator('activeGrowth', data.activeGrowth);
    updateGrowthIndicator('revenueGrowth', data.revenueGrowth);
    updateGrowthIndicator('voucherPercentage', data.voucherPercentage);
}

function updateStatCard(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    }
}

function updateGrowthIndicator(elementId, value) {
    const element = document.getElementById(elementId);
    if (element && value !== undefined) {
        element.textContent = value;
    }
}

function updateRecentActivity(activities) {
    const container = document.getElementById('recentActivity');
    if (!container) return;

    if (activities.length === 0) {
        container.innerHTML = `
            <div class="text-center text-slate-400 py-8">
                <i class="bi bi-clock-history text-4xl mb-3"></i>
                <p>Belum ada aktivitas</p>
            </div>
        `;
        return;
    }

    const activityHTML = activities.slice(0, 10).map(activity => {
        const icon = getActivityIcon(activity.type);
        const color = getActivityColor(activity.type);
        const time = formatTime(activity.timestamp);

        return `
            <div class="flex items-start space-x-3 p-3 hover:bg-slate-700 rounded-lg transition-colors">
                <div class="w-10 h-10 bg-${color}-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i class="bi ${icon} text-${color}-400"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-white text-sm font-medium">${activity.description}</p>
                    <p class="text-slate-400 text-xs">${activity.details || ''}</p>
                    <p class="text-slate-500 text-xs mt-1">${time}</p>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = activityHTML;
}

function updateActiveUsers(data) {
    // Update hotspot users
    const hotspotElement = document.getElementById('hotspotActiveUsers');
    const hotspotProgress = document.getElementById('hotspotProgress');
    if (hotspotElement && data.hotspot !== undefined) {
        hotspotElement.textContent = data.hotspot.count || 0;
        const percentage = Math.min((data.hotspot.count / 100) * 100, 100);
        if (hotspotProgress) {
            hotspotProgress.style.width = `${percentage}%`;
        }
    }

    // Update PPPoE users
    const pppoeElement = document.getElementById('pppoeActiveUsers');
    const pppoeProgress = document.getElementById('pppoeProgress');
    if (pppoeElement && data.pppoe !== undefined) {
        pppoeElement.textContent = data.pppoe.count || 0;
        const percentage = Math.min((data.pppoe.count / 100) * 100, 100);
        if (pppoeProgress) {
            pppoeProgress.style.width = `${percentage}%`;
        }
    }

    // Update total bandwidth
    const bandwidthElement = document.getElementById('totalBandwidth');
    if (bandwidthElement && data.totalBandwidth !== undefined) {
        bandwidthElement.textContent = `${data.totalBandwidth} Mbps`;
    }
}

function getActivityIcon(type) {
    const icons = {
        'voucher_created': 'bi-ticket-perforated',
        'customer_created': 'bi-person-plus',
        'payment_received': 'bi-cash',
        'user_connected': 'bi-wifi',
        'user_disconnected': 'bi-wifi-off',
        'system_backup': 'bi-cloud-download',
        'pppoe_created': 'bi-network-wired'
    };
    return icons[type] || 'bi-info-circle';
}

function getActivityColor(type) {
    const colors = {
        'voucher_created': 'blue',
        'customer_created': 'green',
        'payment_received': 'yellow',
        'user_connected': 'green',
        'user_disconnected': 'red',
        'system_backup': 'purple',
        'pppoe_created': 'purple'
    };
    return colors[type] || 'gray';
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Baru saja';
    if (diffMins < 60) return `${diffMins} menit lalu`;
    if (diffHours < 24) return `${diffHours} jam lalu`;
    if (diffDays < 7) return `${diffDays} hari lalu`;

    return date.toLocaleDateString('id-ID');
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR'
    }).format(amount || 0);
}

function setDefaultValues() {
    // Set loading indicators to default values
    updateStatCard('totalCustomers', '0');
    updateStatCard('activeCustomers', '0');
    updateStatCard('availableVouchers', '0');
    document.getElementById('monthlyRevenue').textContent = 'Rp 0';

    // Set default growth indicators
    updateGrowthIndicator('customersGrowth', '+0%');
    updateGrowthIndicator('activeGrowth', '+0%');
    updateGrowthIndicator('revenueGrowth', '+0%');
    updateGrowthIndicator('voucherPercentage', '0%');

    // Set empty recent activity
    updateRecentActivity([]);

    // Set zero active users
    updateActiveUsers({
        hotspot: { count: 0 },
        pppoe: { count: 0 },
        totalBandwidth: 0
    });
}
</script>

<%- include('../partials/footer') %>